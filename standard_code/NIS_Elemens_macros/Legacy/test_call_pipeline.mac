// Test Macro: Call run_pipeline.exe
// Tests ability to execute run_pipeline.exe with a YAML config file
// Uses Python subprocess since Exec() function does not exist in NIS Elements

int main() {
    // ALL variable declarations at top (critical requirement)
    char temp_yaml_path[300];
    char run_pipeline_path[300];
    char yaml_content[1000];
    char write_yaml_command[1500];
    char python_exec_command[800];
    
    SetCommandText("Testing run_pipeline.exe execution");
    
    // Set paths
    strcpy(run_pipeline_path, "C:/git/run_pipeline/run_pipeline.exe");
    strcpy(temp_yaml_path, "C:/temp/test_pipeline.yaml");
    
    // Verify run_pipeline.exe exists
    if (!ExistFile(run_pipeline_path)) {
        WaitText(0, "ERROR: run_pipeline.exe not found!");
        WaitText(0, run_pipeline_path);
        return;
    }
    
    WaitText(0, "Found run_pipeline.exe");
    
    // Create a simple test YAML config
    strcpy(write_yaml_command, "with open('");
    strcat(write_yaml_command, temp_yaml_path);
    strcat(write_yaml_command, "', 'w') as f: f.write('''pipeline_name: Test Pipeline\\ngroup: test\\nsteps:\\n  - type: pause\\n    message: Pipeline test successful!\\n''')");
    
    WaitText(0, "Creating test YAML config...");
    Python_RunString(write_yaml_command);
    Wait(0.2);
    
    // Verify YAML was created
    if (!ExistFile(temp_yaml_path)) {
        WaitText(0, "ERROR: Failed to create YAML config");
        return;
    }
    
    WaitText(0, "YAML config created successfully");
    WaitText(0, "Executing run_pipeline.exe via Python subprocess...");
    
    // Execute run_pipeline.exe via Python subprocess
    strcpy(python_exec_command, "import subprocess; result = subprocess.run(['");
    strcat(python_exec_command, run_pipeline_path);
    strcat(python_exec_command, "', '");
    strcat(python_exec_command, temp_yaml_path);
    strcat(python_exec_command, "']); print(f'Exit code: {result.returncode}')");
    
    Python_RunString(python_exec_command);
    
    WaitText(0, "Command executed - check console output above");
    
    // Clean up
    Wait(1.0);
    if (ExistFile(temp_yaml_path)) {
        DeleteFile(temp_yaml_path);
        WaitText(0, "Cleaned up temporary YAML file");
    }
    
    WaitText(2, "Test complete!");
}
