// Test Macro: Call run_pipeline.exe
// Tests ability to execute run_pipeline.exe with a YAML config file
// Based on NIS Elements macro language documentation

int main() {
    // ALL variable declarations at top (critical requirement)
    char temp_yaml_path[300];
    char run_pipeline_path[300];
    char yaml_content[1000];
    char write_yaml_command[1500];
    char exec_command[400];
    int exec_result;
    
    SetCommandText("Testing run_pipeline.exe execution");
    
    // Set paths
    strcpy(run_pipeline_path, "C:/git/run_pipeline/run_pipeline.exe");
    strcpy(temp_yaml_path, "C:/temp/test_pipeline.yaml");
    
    // Verify run_pipeline.exe exists
    if (!ExistFile(run_pipeline_path)) {
        WaitText(0, "ERROR: run_pipeline.exe not found!");
        WaitText(0, run_pipeline_path);
        return;
    }
    
    WaitText(0, "Found run_pipeline.exe");
    
    // Create a simple test YAML config
    strcpy(write_yaml_command, "with open('");
    strcat(write_yaml_command, temp_yaml_path);
    strcat(write_yaml_command, "', 'w') as f: f.write('''run:\n  - name: test_step\n    type: pause\n    message: Pipeline test successful!\n''')");
    
    WaitText(0, "Creating test YAML config...");
    Python_RunString(write_yaml_command);
    Wait(0.2);
    
    // Verify YAML was created
    if (!ExistFile(temp_yaml_path)) {
        WaitText(0, "ERROR: Failed to create YAML config");
        return;
    }
    
    WaitText(0, "YAML config created successfully");
    
    // Build command to execute run_pipeline.exe
    strcpy(exec_command, run_pipeline_path);
    strcat(exec_command, " ");
    strcat(exec_command, temp_yaml_path);
    
    WaitText(0, "Executing command:");
    WaitText(0, exec_command);
    
    // Execute run_pipeline.exe (1 = wait for completion)
    exec_result = Exec(exec_command, 1);
    
    if (exec_result == 0) {
        WaitText(0, "SUCCESS: run_pipeline.exe executed successfully!");
    } else {
        WaitText(0, "WARNING: Exec returned non-zero result");
    }
    
    // Clean up
    if (ExistFile(temp_yaml_path)) {
        DeleteFile(temp_yaml_path);
        WaitText(0, "Cleaned up temporary YAML file");
    }
    
    WaitText(2, "Test complete!");
}
